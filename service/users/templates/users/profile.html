{% extends 'content_recommendations/base.html' %}
{% load static %}

{% block css %}
    <!-- Ваши дополнительные CSS стили здесь -->
    <style>
        .profile-info {
            margin-bottom: 20px;
        }

        .profile-image {
            width: 150px;
            height: auto;
            float: left;
            margin-right: 20px;
        }

        .profile-content {
            overflow: hidden; /* Чтобы избежать перекрытия */
        }

        .profile-channel-input {
            margin-bottom: 10px;
        }

        .enter-link {
            font-style: italic;
            color: gray;
        }
    </style>
{% endblock %}

{% block content %}
    <div class="container">
        <h1>Профиль пользователя</h1>
        <div class="row">
            <div class="col-md-4">
                <!-- Изображение пользователя -->
                <div class="profile-info">
                    <img src="{% if user.image %}{{ user.image.url }}{% else %}{% static 'vendor/img/default.jpg' %}{% endif %}" alt="Profile Image" class="profile-image">
                    <form id="image_form" method="post" enctype="multipart/form-data" action="{% url 'index'%}">
                        {% csrf_token %}
                        <input type="file" id="image_input" name="image" style="display: none;"> <!-- Скрытый input[type=file] для загрузки изображения -->
                        <button type="button" id="upload_image" class="btn btn-primary">Добавить изображение</button>
                    </form>
                </div>
                <!-- Информация о пользователе -->
                <div class="profile-info">
                    <h2>Информация о пользователе</h2>
                    <p><strong>Имя:</strong> {{ user.first_name }}</p>
                    <p><strong>Фамилия:</strong> {{ user.last_name }}</p>
                    <p><strong>Email:</strong> {{ user.email }}</p>
                    <p><strong>Дата регистрации:</strong> {{ user.date_joined }}</p>
                    {% if user.youtube_channel %}
                        <p><strong>Ссылка на YouTube:</strong> <a href="{{ user.youtube_channel }}">{{ user.youtube_channel }}</a></p>
                        <button type="button" id="edit_channel" class="btn btn-primary">Изменить ссылку</button>
                    {% else %}
                        <form action="{% url 'users:save_youtube_channel' user.pk %}" method="post">
                            {% csrf_token %}
                            <p><strong>Ссылка на YouTube:</strong> <span class="enter-link">Введите ссылку ниже:</span></p>
                            <input type="text" id="youtube_channel" name="youtube_channel" class="form-control profile-channel-input" placeholder="Введите ссылку на YouTube">
                            <button type="submit" class="btn btn-primary mt-2">Ввести</button>
                        </form>
                    {% endif %}
                </div>
            </div>
            <div class="col-md-8">
                <!-- График контента пользователя -->
                <div id="content-graph">
                    <h2>График контента пользователя</h2>
                    <canvas id="myChart" width="400" height="200"></canvas>
                </div>
                {% if youtube_info %}
                    <div class="profile-info">
                        <h2>Информация о YouTube-канале</h2>
                        <p><strong>Название канала:</strong> {{ youtube_info.title }}</p>
                        <p><strong>Описание канала:</strong> {{ youtube_info.description }}</p>
                        <!-- Возможно, вы хотите отобразить другую информацию о канале -->
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
{% endblock %}

{% block scripts %}
    <!-- Дополнительные скрипты для вашего сайта -->
    <script>
        document.getElementById('upload_image').addEventListener('click', function () {
            document.getElementById('image_input').click(); // При нажатии на кнопку "Загрузить", вызываем событие клика на input[type=file]
        });

        document.getElementById('edit_channel').addEventListener('click', function () {
            var youtubeChannelInput = document.getElementById('youtube_channel');
            youtubeChannelInput.style.display = 'block';
            this.style.display = 'none';
            youtubeChannelInput.focus();
        });

        // Обработчик события для input[type=file]
        document.getElementById('image_input').addEventListener('change', function () {
            var form = document.getElementById('image_form'); // Получаем форму
            var formData = new FormData(form); // Создаем объект FormData для отправки формы
            var xhr = new XMLHttpRequest(); // Создаем новый объект XMLHttpRequest

            xhr.onreadystatechange = function () {
                if (xhr.readyState === XMLHttpRequest.DONE) { // Проверяем состояние запроса
                    if (xhr.status === 200) { // Проверяем статус ответа
                        // Действия при успешной загрузке изображения
                        alert('Изображение успешно загружено!');
                        window.location.reload(); // Перезагружаем страницу после загрузки изображения
                    } else {
                        // Действия при ошибке загрузки изображения
                        alert('Ошибка загрузки изображения!');
                    }
                }
            };

            xhr.open('POST', form.action); // Устанавливаем метод и URL для запроса
            xhr.setRequestHeader('X-CSRFToken', '{{ csrf_token }}'); // Устанавливаем CSRF-токен в заголовке запроса
            xhr.send(formData); // Отправляем форму на сервер
        });
    </script>
{% endblock %}
